let a,m,s,i=[],h=0,u,p;const D=()=>{a=new AudioContext,i=[new Audio("/sound.mp3"),new Audio("/sound2.mp3")],i.forEach(t=>{t.loop=!1}),m=a.createMediaElementSource(i[h]),s=a.createAnalyser(),s.fftSize=512,s.smoothingTimeConstant=.6,p=s.frequencyBinCount,u=new Uint8Array(p),m.connect(s),s.connect(a.destination),i.forEach((t,y)=>{t.addEventListener("ended",()=>{l&&(h=(y+1)%i.length,m.disconnect(),m=a.createMediaElementSource(i[h]),m.connect(s),i[h].play())})})};let l=!1,E;const z=document.getElementById("musicPlayer"),b=z?.querySelector(".play-icon"),x=z?.querySelector(".pause-icon"),r=document.getElementById("visualizer"),d=r.getContext("2d"),C=()=>{r.width=150,r.height=150,r.style.width="150px",r.style.height="150px"};C();window.addEventListener("resize",C);const I=()=>{if(!s||!u)return;s.getByteFrequencyData(u),d.clearRect(0,0,r.width,r.height);const t=r.width/2,y=35,S=2,M=1.5,P=1,v=(e,n)=>{let c=0;for(let o=e;o<n&&o<p;o++)c+=u[o];return c/(n-e)},k=v(0,4),q=v(4,12),B=v(12,p),f=[];for(let e=0;e<p;e++){const n=u[e],c=e<p-1?u[e+1]:u[e];f.push(n);const o=(c-n)/8;for(let g=1;g<8;g++)f.push(n+o*g)}const A=f.length;for(let e=0;e<A;e++){let n=P;e<32?n=S:e<96&&(n=M);let c=B;e<32?c=k:e<96&&(c=q);const o=f[e]/255,g=(o*n*50+c*.2)*(l?1:.3),w=e*2*Math.PI/A,L=t+y*Math.cos(w),T=t+y*Math.sin(w),W=t+(y+g)*Math.cos(w),$=t+(y+g)*Math.sin(w);d.beginPath(),d.moveTo(L,T),d.lineTo(W,$);const F=e/A*360;d.strokeStyle=l?`hsla(${F}, 80%, 60%, ${o*.8+.2})`:"rgba(255, 255, 255, 0.3)",d.lineWidth=1.5,d.stroke()}E=requestAnimationFrame(I)},U=()=>{l?(b.style.display="none",x.style.display="block"):(b.style.display="block",x.style.display="none")},X=t=>{window.dispatchEvent(new CustomEvent("audioplayerstatechange",{detail:{isPlaying:t,audioElement:i[h],audioContext:a,analyser:s}}))};z?.addEventListener("click",()=>{a||D(),a.state==="suspended"&&a.resume(),l=!l,l?(i[h].play(),I()):(i[h].pause(),E&&cancelAnimationFrame(E)),U(),X(l)});
